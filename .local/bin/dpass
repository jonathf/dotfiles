#!/usr/bin/env bash

shopt -s nullglob globstar

prefix=${PASSWORD_STORE_DIR-~/.password-store}
password_files=( "$prefix"/**/*.gpg )
password_files=( "${password_files[@]#"$prefix"/}" )
password_files=( "${password_files[@]%.gpg}" )

selected=$(printf "%s\n%s\n" $(cat /tmp/dpass) ${password_files[@]} | sed -e 's/.gpg//' | dmenu -l 20 -fn "Ubuntu Mono-14:normal")
popd

[ -z "$selected" ] && exit

dpass_insert $selected
echo "$selected
$(head -2 /tmp/dpass 2>/dev/null)" > /tmp/dpass
